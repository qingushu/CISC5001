<html>
    <head>
        <!--Load the AJAX API-->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">

            // Load the Visualization API and the corechart package.
            google.charts.load('current', {'packages': ['corechart']});

            // Set a callback to run when the Google Visualization API is loaded.
            google.charts.setOnLoadCallback(drawVisualization);

            function joinAndDraw(tables){
              console.log("arrived");
              console.log(Array.isArray(tables));

              console.log(tables[0].getNumberOfRows());
              console.log(tables[1].getNumberOfRows());

            // join two data tables
            var joinData = new google.visualization.data.join(tables[0], tables[1],'left', [[0,0]],[3,4],[1,1]);
            var keys = [];
            for (var i = 0; i < tables[0].getNumberOfColumns(); i++) {
                keys.push([i, i]);
              }


              //filter Male students who took CISC1110
              var rows = joinData.getFilteredRows([{column: 1, value: 1110}, {column: 3, value: 'M'}]);


              //re organize the filtered rows to a data table
              var view1 = new google.visualization.DataView(joinData);
              view1.setRows(rows);
              var newData = view1.toDataTable();


              // all distinct values of letter grade
              var distinctValues = ['A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D', 'W', 'WU', 'WD', 'F'];

                var viewColumns = [0, 1];
                var groupColumns = [];
                var totalNumber = [];

                //select each student's grade and make each grade as a column
                for (var i = 0; i < distinctValues.length; i++) {
                    viewColumns.push({
                        type: 'number',
                        label: distinctValues[i],
                        calc: (function (x) {
                            return function (dt, row) {
                                return (dt.getValue(row, 2) == x) ? 1 : 0;
                            }
                        })(distinctValues[i])
                    });

                    groupColumns.push({
                        column: i+2,
                        type: 'number',

                       aggregation: google.visualization.data.sum
                    });
                }







                var view = new google.visualization.DataView(newData);
                view.setColumns(viewColumns);


                var pivotedData = google.visualization.data.group(view, [0, 1], groupColumns);


                //create a new data table for displaying the result
                var newTotal = [];
                var totalTable = new google.visualization.DataTable();
                totalTable.addColumn('string', 'Letter of Grade');
                totalTable.addColumn('number', 'Grade');



                  //call calcTotal to calculate the sum and then add each number to the new data table
                for(var i = 2; i < distinctValues.length; i++){
                  newTotal[i]  = calcTotal(distinctValues[i], i);
                  totalTable.addRow([ distinctValues[i],  newTotal[i].getValue(0, 1)]);

                }




                // draw data table
              var table = new google.visualization.ChartWrapper({
                    'chartType': 'Table',
                    'dataTable': totalTable,
                    'containerId': 'Time',
              });
                table.draw();



                  // calculate the sum of each column
                    function calcTotal(grade ,totalGrade) {
                      var dataTotal = google.visualization.data.group(
                        pivotedData,
                        [{column: 0, type: 'string', modifier: function () {return grade;}}],
                        [
                          {
                            aggregation: google.visualization.data.sum,
                            column: totalGrade,
                            label: 'Total',
                            type: 'number'
                          }
                        ]
                      );

                      return dataTotal;
                      }



           }



            function drawVisualization() {

                var timeDataTable;
                var demoDataTable;

                var queryString = ""; // encodeURIComponent('LIMIT 5');

                var timeSheetURL = 'https://docs.google.com/spreadsheets/d/1PV1YqyqkwkR0DJgxxVHFAOm0GvUemIlh4hE5ZqmvLNg/gviz/tq?sheet=Time&headers=1';
                var demoSheetURL = 'https://docs.google.com/spreadsheets/d/1PV1YqyqkwkR0DJgxxVHFAOm0GvUemIlh4hE5ZqmvLNg/gviz/tq?sheet=Demographics&headers=1'

                var timeURL = timeSheetURL + queryString;
                var demoURL = demoSheetURL + queryString;

                function handleError(message) {
                    alert(message);
                }

                function setTimeTable(response) {
                  console.log("setTimeTable");

                    timeDataTable = response.getDataTable();
                    console.log(timeDataTable.getNumberOfRows());
                }

                function setDemoTable(response) {
                  console.log("setDemoTable");

                    demoDataTable = response.getDataTable();
                    console.log(demoDataTable.getNumberOfRows());

                }

                function wrapTable(response) {
                  console.log("wrapTable");
                  return response.getDataTable();
                }

                // this is where action begins

                function loadData(url) {
                  console.log(url);
                  return new Promise(
                    function(resolve, reject) {
                      var query = new google.visualization.Query(url);
                      query.send(function (response) {
                          if(response.isError()) {
                            reject(response.getMessage() + ' ' + response.getDetailedMessage());
                          } else {
                            resolve(response);
                          }
                       }
                    )}
                  )
                }

                // we want to do these "in parallel" and when both are done, combine data and draw chart.
                // how do we do that with two Promises?

               Promise.all([loadData(timeURL).then(wrapTable, handleError),
                               loadData(demoURL).then(wrapTable, handleError)]).
                          then(joinAndDraw);

            }





        </script>
    </head>

    <body>
        <!--Div that will hold the pie chart-->
        <div id="Time"></div>
    </body>
</html>
