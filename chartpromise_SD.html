    <html>
    <head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

// Load the Visualization API and the corechart package.
google.charts.load('current', {'packages': ['corechart']});

// Set a callback to run when the Google Visualization API is loaded.
google.charts.setOnLoadCallback(drawVisualization);

function joinAndDraw(tables){

    // join two data tables
    var joinData = new google.visualization.data.join(tables[0], tables[1],'left', [[0,0]],[3,4],[1,1]);

    //filter Male students who took CISC1110
    var rows = joinData.getFilteredRows([{column: 1, value: 1110}, {column: 3, value: 'M'}]);

    // create a view of only the selected rows

    var view1 = new google.visualization.DataView(joinData);
    view1.setRows(rows);

    // get dt of selected rows
    var dataM3110 = view1.toDataTable();

    // create table of grades and counts
    var gradeTable = google.visualization.data.group(dataM3110, [2],
                                                     [{'column':0,
                                                       'aggregation': google.visualization.data.count,
                                                       'type': 'number'}]);

    // all desired values of letter grade
    var gradeValues = ['A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D', 'W', 'WU', 'WD', 'F'];
    
    // filter out rows with no grade, starred (replaced) grades, etc--only count the 'real' grades
    var gradeRows = gradeTable.getFilteredRows([{column:0, test: x => gradeValues.includes(x)}]);


    // create view of desired rows
    var view2 = new google.visualization.DataView(gradeTable);
    view2.setRows(gradeRows);

    // make bar chart of desired rows
    var chart = new google.visualization.BarChart(document.getElementById('Time'));
    chart.draw(view2);
    
    /*
    var filteredGradeTable = view2.toDataTable();
    
    // draw data table
    var table = new google.visualization.ChartWrapper({
        'chartType': 'Table',
        'dataTable': filteredGradeTable,
        'containerId': 'Time',
    });
    table.draw();

                                                    
                                                     


    // how does this code work? is it necessary? **

    var viewColumns = [0, 1];
    var groupColumns = [];
    var totalNumber = [];

    //select each student's grade and make each grade as a column
    for (var i = 0; i < distinctValues.length; i++) {
        viewColumns.push({
            type: 'number',
            label: distinctValues[i],
            calc: (function (x) {
                return function (dt, row) {
                    return (dt.getValue(row, 2) == x) ? 1 : 0;
                }
            })(distinctValues[i])
        });

        groupColumns.push({
            column: i+2,
            type: 'number',

            aggregation: google.visualization.data.sum
        });
    }



    // what is keys array for?  **
    var keys = [];
    for (var i = 0; i < tables[0].getNumberOfColumns(); i++) {
        keys.push([i, i]);
    }




    var view = new google.visualization.DataView(newData);
    view.setColumns(viewColumns);


    var pivotedData = google.visualization.data.group(view, [0, 1], groupColumns);


    //create a new data table for displaying the result
    var newTotal = [];
    var totalTable = new google.visualization.DataTable();
    totalTable.addColumn('string', 'Letter of Grade');
    totalTable.addColumn('number', 'Grade');



    //call calcTotal to calculate the sum and then add each number to the new data table
    for(var i = 2; i < distinctValues.length; i++){
        newTotal[i]  = calcTotal(distinctValues[i], i);
        totalTable.addRow([ distinctValues[i],  newTotal[i].getValue(0, 1)]);

    }




    // draw data table
    var table = new google.visualization.ChartWrapper({
        'chartType': 'Table',
        'dataTable': totalTable,
        'containerId': 'Time',
    });
    table.draw();



    // calculate the sum of each column
    function calcTotal(grade ,totalGrade) {
        var dataTotal = google.visualization.data.group(
            pivotedData,
            [{column: 0, type: 'string', modifier: function () {return grade;}}],
            [
                {
                    aggregation: google.visualization.data.sum,
                    column: totalGrade,
                    label: 'Total',
                    type: 'number'
                }
            ]
        );

        return dataTotal;
    }

*/
}

// "main" function. primary task to load data from google sheets, then hand data off for manipulation and
// visualization

function drawVisualization() {

    var timeDataTable;
    var demoDataTable;

    var queryString = ""; // encodeURIComponent('LIMIT 5');

    var timeSheetURL = 'https://docs.google.com/spreadsheets/d/1PV1YqyqkwkR0DJgxxVHFAOm0GvUemIlh4hE5ZqmvLNg/gviz/tq?sheet=Time&headers=1';
    var demoSheetURL = 'https://docs.google.com/spreadsheets/d/1PV1YqyqkwkR0DJgxxVHFAOm0GvUemIlh4hE5ZqmvLNg/gviz/tq?sheet=Demographics&headers=1'

    var timeURL = timeSheetURL + queryString;
    var demoURL = demoSheetURL + queryString;

    function handleError(message) {
        alert(message);
    }

    function setTimeTable(response) {
        console.log("setTimeTable");

        timeDataTable = response.getDataTable();
        console.log(timeDataTable.getNumberOfRows());
    }

    function setDemoTable(response) {
        console.log("setDemoTable");

        demoDataTable = response.getDataTable();
        console.log(demoDataTable.getNumberOfRows());

    }

    function wrapTable(response) {
        console.log("wrapTable");
        return response.getDataTable();
    }

    // this is where action begins

    function loadData(url) {
        console.log(url);
        return new Promise(
            function(resolve, reject) {
                var query = new google.visualization.Query(url);
                query.send(function (response) {
                    if(response.isError()) {
                        reject(response.getMessage() + ' ' + response.getDetailedMessage());
                    } else {
                        resolve(response);
                    }
                }
                          )}
        )
    }

    // call loadData() asynchronously to load time and demographic data tables, then call
    // joinAndDraw() to render visualization

    Promise.all([loadData(timeURL).then(wrapTable, handleError),
                 loadData(demoURL).then(wrapTable, handleError)]).
        then(joinAndDraw);

}

</script>
    </head>

    <body>
    <!--Div that will hold the pie chart-->
    <div id="Time"></div>
    </body>
    </html>
